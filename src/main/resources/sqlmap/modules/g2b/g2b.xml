<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.lx.rcic.modules.g2b.mapper.G2bMapper">

    <resultMap id="g2bResultMap" type="kr.or.lx.rcic.modules.g2b.entity.G2b">
        <!-- 수집로그번호 -->
        <result property="logSeq" column="log_seq"/>
        <!-- 서비스번호 -->
        <result property="serviceNo" column="service_no"/>
        <!-- 시작일시 -->
        <result property="startDt" column="start_dt"/>
        <!-- 종료일시 -->
        <result property="endDt" column="end_dt"/>
        <!-- 수집키워드 -->
        <result property="keyword" column="keyword"/>
        <!-- 수집데이터건수 -->
        <result property="getDataCnt" column="getdatacnt"/>
        <!-- 변환데이터건수 -->
        <result property="converterDataCnt" column="converterdatacnt"/>
        <!-- 기준일시 -->
        <result property="stdrDt" column="stdrdt"/>
        <!-- 검색시작일시 -->
        <result property="searchStartDt" column="search_start_dt"/>
        <!-- 검색종료일시 -->
        <result property="searchEndDt" column="search_end_dt"/>
        <!-- 분석건수 -->
        <result property="anaysisCnt" column="anaysiscnt"/>
    </resultMap>

    <sql id="whereConditions">
        <where>
            <include refid="conditions" />
        </where>
    </sql>

    <sql id="conditions">
        <if test="logSeq != null and logSeq != ''">
            AND log_seq = #{logSeq}
        </if>
        <if test="serviceNo != null and serviceNo != ''">
            AND service_no = #{serviceNo}
        </if>
        <if test="startDt != null and startDt != ''">
            AND start_dt = #{startDt}
        </if>
        <if test="endDt != null and endDt != ''">
            AND end_dt = #{endDt}
        </if>
        <if test="keyword != null and keyword != ''">
            AND keyword LIKE CONCAT('%', #{keyword}, '%')
        </if>
        <if test="getDataCnt != null and getDataCnt != ''">
            AND getDataCnt = #{getDataCnt}
        </if>
        <if test="converterDataCnt != null and converterDataCnt != ''">
            AND converterDataCnt = #{converterDataCnt}
        </if>
         <if test="stdrDt != null and stdrDt != ''">
            AND stdrDt = #{stdrDt}
        </if>
        <if test="searchStartDt != null and searchStartDt != ''">
            AND search_start_dt = #{searchStartDt}
        </if>
        <if test="searchEndDt != null and searchEndDt != ''">
            AND search_end_dt = #{searchEndDt}
        </if>
        <if test="anaysisCnt != null and anaysisCnt != ''">
            AND anaysisCnt = #{anaysisCnt}
        </if>
    </sql>


    <select id="selectG2bCnt" resultType="int">
      select 
	  	    count(*)
	    from  
	        (
			select    
			    sum(a.getdatacnt) as getdatacnt,
				to_date(substring(a.start_dt::varchar,0,9), 'YYYYMMDD') as start_dt,
				to_date(substring(a.search_start_dt::varchar,0,9), 'YYYYMMDD') as search_start_dt,
	 			to_date(substring(a.search_end_dt::varchar,0,9), 'YYYYMMDD') as search_end_dt
			 from
			    rcic.tb_intf_log_info a
			 group by
				 a.start_dt, 
				 a.search_start_dt, 
				 a.search_end_dt 
		     ) b
         <include refid="whereConditions"/>
    </select>

    <select id="selectG2bList" resultType="egovMap">
        <include refid="common.headerRow"/>
       select 
	  	    b.getdatacnt,
			b.start_dt,
			b.search_start_dt,
			b.search_end_dt
	    from  
	        (
			select    
			    sum(a.getdatacnt) as getdatacnt,
				to_date(substring(a.start_dt::varchar,0,9), 'YYYYMMDD') as start_dt,
				to_date(substring(a.search_start_dt::varchar,0,9), 'YYYYMMDD') as search_start_dt,
	 			to_date(substring(a.search_end_dt::varchar,0,9), 'YYYYMMDD') as search_end_dt
			 from
			    rcic.tb_intf_log_info a
			 group by
				 a.start_dt, 
				 a.search_start_dt, 
				 a.search_end_dt 
		     ) b
        <include refid="whereConditions"/>
         order by start_dt desc
        <include refid="common.footerRow"/>
	</select>
	
	<select id="selectAnalCnt" resultType="int">
      SELECT 
     		count(*) 
        FROM 
		    rcic.TB_ANALYSIS_INFO c 
	   WHERE 
	  	 	to_date(c.stdr_dt, 'YYYYMMDD') <![CDATA[>=]]> to_date(#{start}, 'YYYYMMDD')
			AND 
			to_date(c.stdr_dt, 'YYYYMMDD') <![CDATA[<=]]> to_date(#{end}, 'YYYYMMDD')
    </select>
</mapper>

