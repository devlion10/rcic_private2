<?xml version="1.0" encoding="UTF-8"?>
<!--
 ! Source code generated by Celerio, a Jaxio product.
 ! Documentation: http://www.jaxio.com/documentation/celerio/
 ! Follow us on twitter: @jaxiosoft
 ! Need commercial support ? Contact us: info@jaxio.com
 ! Template pack-rcic:src/main/resources/sqlmap/modules/SqlMap.e.vm.xml
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.lx.rcic.modules.dataapi.mapper.ApiStatisticsMapper">

    <select id="getApiUseStatistics" resultType="egovMap">
        select de as use_de
             , data.api_provd_no
             , data.api_provd_no as group_key
             , coalesce(data.cnt, 0) as summary
        from (
            <if test='periodType == "M" or periodType == "Q"'>
            SELECT to_char( t.*, 'YYYYMM') as de
              FROM generate_series(#{startDt}::date, #{endDt}::date, '1 months'::interval) as t
            </if>
            <if test='periodType == "Y"'>
            SELECT to_char( t.*, 'YYYY') as de
              FROM generate_series(#{startDt}::date, #{endDt}::date, '1 years'::interval) as t
            </if>
              ) tt
        LEFT OUTER JOIN (

            select api_provd_no
                <if test='periodType == "M" or periodType == "Q"'>
                   , substr(use_de, 0, 7) as use_de
                </if>
                <if test='periodType == "Y"'>
                   , substr(use_de, 0, 5) as use_de
                </if>
                   , count(*) as cnt
              from rcic.tb_api_use_dtl
             where use_de <![CDATA[>=]]> #{startDt}
               and use_de <![CDATA[<=]]> #{endDt}
          group by 1
                 , 2

            ) as data ON data.use_de = tt.de
    ORDER BY use_de DESC
    </select>


    <select id="getDataUseStatistics" resultType="egovMap">
        select de as use_de
             , data.data_knd as group_key
             , coalesce(data.cnt, 0) as summary
        from (

            <if test='periodType == "M" or periodType == "Q"'>
            SELECT to_char( t.*, 'YYYYMM') as de
              FROM generate_series(#{startDt}::date, #{endDt}::date, '1 months'::interval) as t
            </if>
            <if test='periodType == "Y"'>
            SELECT to_char( t.*, 'YYYY') as de
              FROM generate_series(#{startDt}::date, #{endDt}::date, '1 years'::interval) as t
            </if>
              ) tt
        LEFT OUTER JOIN (

            select master.data_knd
                <if test='periodType == "M" or periodType == "Q"'>
                   , to_char(down_dt, 'YYYYMM') as use_de
                </if>
                <if test='periodType == "Y"'>
                   , to_char(down_dt, 'YYYY') as use_de
                </if>
                   , count(*) as cnt
              from rcic.tb_data_use_dtl dtl
              join rcic.tb_data_provd_info master on master.data_provd_no = dtl.data_provd_no
             where down_dt <![CDATA[>=]]> to_date(#{startDt}, 'YYYYMMDD')
               and down_dt <![CDATA[<=]]> to_date(#{endDt}, 'YYYYMMDD')
          group by 1
                 , 2

            ) as data ON data.use_de = tt.de
    ORDER BY use_de DESC
    </select>
    
</mapper>