<?xml version="1.0" encoding="UTF-8"?>
<!--
 ! Source code generated by Celerio, a Jaxio product.
 ! Documentation: http://www.jaxio.com/documentation/celerio/
 ! Follow us on twitter: @jaxiosoft
 ! Need commercial support ? Contact us: info@jaxio.com
 ! Template pack-rcic:src/main/resources/sqlmap/modules/SqlMap.e.vm.xml
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.lx.rcic.modules.analysisLocHist.mapper.AnalysisLocHistMapper">

    <resultMap id="analysisLocHistResultMap" type="kr.or.lx.rcic.modules.analysisLocHist.entity.AnalysisLocHist">
        <!-- 시퀀스 -->
        <result property="seq" column="seq"/>
        <!-- 일련번호 -->
        <result property="serNo" column="ser_no"/>
        <!-- 변경일시 -->
        <result property="chgDt" column="chg_dt"/>
        <!-- 변경방법 -->
        <result property="chgResnCd" column="chg_resn_cd"/>
        <!-- 변경방법설명 -->
        <result property="chgResnDc" column="chg_resn_dc"/>
        <!-- 위치공간정보 -->
        <result property="geom" column="geom"/>
        <!-- 위치예측신뢰도코드 -->
        <result property="locPrdtReliCd" column="loc_prdt_reli_cd"/>
        <!-- 등록일시 -->
        <result property="registDt" column="regist_dt"/>
        <!-- 등록아이디 -->
        <result property="registId" column="regist_id"/>
    </resultMap>

    <sql id="whereConditions">
        <where>
            <include refid="conditions" />
        </where>
    </sql>

    <sql id="conditions">
        <if test="seq != null">
            AND seq = #{seq}
        </if>
        <if test="locTy != null">
            AND loc_ty = #{locTy}
        </if>
        <if test="serNo != null">
            AND ser_no = #{serNo}
        </if>
        <if test="chgDt != null and chgDt.enabled == true">
            
            <if test="chgDtEq != null and chgDtEq != ''">
            AND chg_dt = STR_TO_DATE(#{chgDtEq}, '%Y.%m.%d')
            </if>
            
            <if test="chgDtFrom != null and chgDtFrom != ''">
            AND chg_dt <![CDATA[ >= ]]> STR_TO_DATE(#{chgDtFrom}, '%Y.%m.%d')
            </if>

            <if test="chgDtTo != null and chgDtTo != ''">
            AND chg_dt <![CDATA[ < ]]> DATE_ADD(STR_TO_DATE(#{chgDtTo}, '%Y.%m.%d'), INTERVAL 1 DAY)
            </if>
        </if>
        <if test="chgResnCd != null and chgResnCd != ''">
            AND chg_resn_cd = #{chgResnCd}
        </if>
        <if test="chgResnDc != null and chgResnDc != ''">
            AND chg_resn_dc = #{chgResnDc}
        </if>
        <if test="geom != null">
            AND geom = #{geom}
        </if>
        <if test="locPrdtReliCd != null and locPrdtReliCd != ''">
            AND loc_prdt_reli_cd = #{locPrdtReliCd}
        </if>
        <if test="registDt != null and registDt.enabled == true">
            
            <if test="registDtFrom != null and registDtFrom != ''">
            AND regist_dt <![CDATA[ >= ]]> STR_TO_DATE(#{registDtFrom}, '%Y.%m.%d')
            </if>

            <if test="registDtTo != null and registDtTo != ''">
            AND regist_dt <![CDATA[ < ]]> DATE_ADD(STR_TO_DATE(#{registDtTo}, '%Y.%m.%d'), INTERVAL 1 DAY)
            </if>
        </if>
        <if test="registId != null and registId != ''">
            AND regist_id = #{registId}
        </if>
    </sql>

    <select id="getAnalysisLocHist" resultMap="analysisLocHistResultMap">
        /* kr.or.lx.rcic.modules.analysisLocHist.mapper.AnalysisLocHistMapper.getAnalysisLocHist */

        SELECT
            seq, ser_no, chg_dt, chg_resn_cd, chg_resn_dc, geom, loc_prdt_reli_cd, regist_dt, regist_id
        FROM rcic.tb_analysis_loc_hist
        WHERE
         seq = #{seq}
         AND  ser_no = #{serNo}
	</select>

    <select id="selectAnalysisLocHistCnt" resultType="int">
        /* kr.or.lx.rcic.modules.analysisLocHist.mapper.AnalysisLocHistMapper.simpleListAnalysisLocHistCnt */

        SELECT COUNT(*)
        FROM rcic.tb_analysis_loc_hist
        <include refid="whereConditions" />
    </select>

    
    <select id="selectAnalysisLocHistList" resultType="egovMap">
        /* kr.or.lx.rcic.modules.analysisLocHist.mapper.AnalysisLocHistMapper.selectAnalysisLocHistList */

        <include refid="common.headerRow"/>
        SELECT
            seq, loc_ty, ser_no, chg_dt, chg_resn_cd, chg_resn_dc, geom, loc_prdt_reli_cd, regist_dt, regist_id
        FROM rcic.tb_analysis_loc_hist
        <include refid="whereConditions" />
        <include refid="common.footerRow"/>
	</select>
	
	<select id="selectAnalysisLocHistNew" resultType="egovMap">
		select seq
			  ,loc_ty
			  ,ser_no
		      ,chg_dt
		      ,chg_resn_cd
		      ,chg_resn_dc
		      ,geom
		      ,public.GeometryType(geom) as geom_type
		      ,public.ST_AsGeoJSON(GEOM) as geo_geom
		      ,loc_prdt_reli_cd
		      ,regist_dt
		      ,regist_id
		      ,ref_dic_name
		      ,ref_dic_name_og
		      ,changereason
		      ,serword
		      ,serword_og
		from
			rcic.tb_analysis_loc_hist
		<include refid="whereConditions" />
		order by
			ser_no desc
		limit 1
	</select>

    <update id="updateAnalysisLocHist" parameterType="kr.or.lx.rcic.modules.analysisLocHist.entity.AnalysisLocHist">
        /* kr.or.lx.rcic.modules.analysisLocHist.mapper.AnalysisLocHistMapper.updateAnalysisLocHist */

        UPDATE rcic.tb_analysis_loc_hist
        SET
               chg_dt = #{chgDt}
                    , chg_resn_cd = #{chgResnCd}
                    , chg_resn_dc = #{chgResnDc}
                    , geom = #{geom}
                    , loc_prdt_reli_cd = #{locPrdtReliCd}
                  WHERE
             seq = #{seq}
             AND  ser_no = #{serNo}
    </update>

    <update id="updateAnalysisLocHistDynamic" parameterType="kr.or.lx.rcic.modules.analysisLocHist.entity.AnalysisLocHist">
        /* kr.or.lx.rcic.modules.analysisLocHist.mapper.AnalysisLocHistMapper.updateAnalysisLocHistDynamic */

        UPDATE rcic.tb_analysis_loc_hist
            <set>
            <if test="chgDt != null">
                chg_dt = #{chgDt},
            </if>
            <if test="chgResnCd != null and chgResnCd != ''">
                chg_resn_cd = #{chgResnCd},
            </if>
            <if test="chgResnDc != null and chgResnDc != ''">
                chg_resn_dc = #{chgResnDc},
            </if>
            <if test="geom != null">
                geom = #{geom},
            </if>
            <if test="locPrdtReliCd != null and locPrdtReliCd != ''">
                loc_prdt_reli_cd = #{locPrdtReliCd},
            </if>
            <if test="registDt != null">
                regist_dt = #{registDt},
            </if>
            <if test="registId != null and registId != ''">
                regist_id = #{registId},
            </if>
            </set>
        WHERE
             seq = #{seq}
             AND  ser_no = #{serNo}
    </update>

    <delete id="deleteAnalysisLocHist" parameterType="kr.or.lx.rcic.modules.analysisLocHist.entity.AnalysisLocHist">
        /* kr.or.lx.rcic.modules.analysisLocHist.mapper.AnalysisLocHistMapper.deleteAnalysisLocHist */

        DELETE FROM rcic.tb_analysis_loc_hist
        WHERE
             seq = #{seq}
             AND  ser_no = #{serNo}
    </delete>

    <insert id="insertAnalysisLocHist">
    	<selectKey resultType="long" keyColumn="ser_no" keyProperty="serNo" order="BEFORE">
            SELECT nextval('rcic.sq_tb_analysis_loc_hist')
        </selectKey>
        /* kr.or.lx.rcic.modules.analysisLocHist.mapper.AnalysisLocHistMapper.insertAnalysisLocHist */
        INSERT INTO rcic.tb_analysis_loc_hist
        (
        seq, loc_ty, ser_no, chg_dt, chg_resn_cd, chg_resn_dc, geom, loc_prdt_reli_cd, regist_dt, regist_id,ref_dic_name_og,ref_dic_name,changereason,serword_og,serword
        )
        VALUES (
        #{seq},
        #{locTy},
        #{serNo},
        NOW(),
        NULL,
        NULL,
        public.ST_GeomFromText(#{geom},3857),
        NULL,
        NOW(),
        #{registId},
        #{ReferenceNameDic_og},
        #{ReferenceNameDic},
        #{ChangeReason},
        #{SearchWord_og},
        #{SearchWord}
        )
	</insert>
	
	<update id ="updateChangeLocation">
	update tb_analysis_score set locchange_yn ='Y' where resultno=#{resultno}
	</update>
	
	<select id="getChnage_yn" resultType="String">
		select distinct locchange_yn from rcic.tb_analysis_score where resultno=#{resultno}
	</select>
	


</mapper>

